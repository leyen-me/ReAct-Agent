name: Build Binaries

on:
  push:
    tags:
      - 'v*'  # 当推送版本标签时触发，如 v1.0.0
  workflow_dispatch:  # 允许手动触发
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            artifact_name: ask-linux
            binary_name: ask
          - os: windows-latest
            artifact_name: ask-windows
            binary_name: ask.exe
          - os: macos-latest
            artifact_name: ask-macos
            binary_name: ask

    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build binary
      run: |
        pyinstaller react_agent.spec --clean --noconfirm

    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        fi
      shell: bash

    - name: Rename binary with version (Linux/macOS)
      if: matrix.os != 'windows-latest'
      run: |
        cd dist
        mv ask ask-${{ steps.get_version.outputs.version }}
        chmod +x ask-${{ steps.get_version.outputs.version }}
      shell: bash

    - name: Rename binary with version (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        cd dist
        Rename-Item -Path "ask.exe" -NewName "ask-${{ steps.get_version.outputs.version }}.exe"
      shell: pwsh

    - name: List dist files (debug)
      if: matrix.os == 'windows-latest'
      run: |
        Get-ChildItem dist
      shell: pwsh

    - name: List dist files (debug)
      if: matrix.os != 'windows-latest'
      run: |
        ls -la dist
      shell: bash

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}-${{ steps.get_version.outputs.version }}
        path: |
          dist/ask-${{ steps.get_version.outputs.version }}*
        if-no-files-found: error
        retention-days: 30

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/ask-${{ steps.get_version.outputs.version }}*
        tag_name: v${{ steps.get_version.outputs.version }}
        name: Release v${{ steps.get_version.outputs.version }}
        body: |
          ## ReAct Agent v${{ steps.get_version.outputs.version }}
          
          ### 下载
          - **Linux**: [ask-linux-${{ steps.get_version.outputs.version }}](https://github.com/${{ github.repository }}/releases/download/v${{ steps.get_version.outputs.version }}/ask-linux-${{ steps.get_version.outputs.version }})
          - **Windows**: [ask-windows-${{ steps.get_version.outputs.version }}.exe](https://github.com/${{ github.repository }}/releases/download/v${{ steps.get_version.outputs.version }}/ask-windows-${{ steps.get_version.outputs.version }}.exe)
          - **macOS**: [ask-macos-${{ steps.get_version.outputs.version }}](https://github.com/${{ github.repository }}/releases/download/v${{ steps.get_version.outputs.version }}/ask-macos-${{ steps.get_version.outputs.version }})
          
          ### 使用方法
          1. 下载对应平台的可执行文件
          2. 设置环境变量：`export OPENAI_API_KEY=your_key` (Linux/macOS) 或 `set OPENAI_API_KEY=your_key` (Windows)
          3. 运行程序：
             - Linux/macOS: `chmod +x ask-* && ./ask-*`
             - Windows: `ask-*.exe`
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

